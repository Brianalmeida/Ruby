#!/usr/bin/ruby

# Objectives
#
# Make sure you can read the csv file for the List and DB varible
#
# Do a search for the list of CVEs using the DB file
#
# Output the CVE
#
# Output the csv line with the corresponding CVE
#
# Clean up the code once done
#
#

require 'csv'

#puts "What CVE would like to look for? "
#answer = gets.chomp

$total_cve = 22

def SEARCH_CVES

  cveDB = "./report-v2.7.10-cves.csv"
  cveList = "./cve-list.csv"
  ghsa_search = []
  test_memory = []

  cve_hash = Array.new

  CSV.foreach("#{cveList}") do |listing|
    cve_hash << listing.to_s

    CSV.foreach("#{cveDB}", headers: 'image,package_name,vulnerability_id,severity') do |row|

      if $total_cve == listing.length
        if true
          listing.each do |iterate|
            test_memory << listing.grep(/^CVE-\d{4}-\d{4,}$/) in row
            if test_memory == listing.grep(/^CVE/)
              break
              puts "Pausing..."
              test_memory.grep(listing) in row
              return test_memory
            elsif test_memory != listing
              break
              puts "Something is not right, stopping"
            end
          end

        elsif test_memory == listing.grep(/GHSA/)
            ghsa_search << listing.max == "/^GHSA/"
            return ghsa_search
        else
          puts "Stopping"
        end
      elsif $total_cve != listing.length
        puts "Total of CVEs do not match!"
      end
    end
  end
end

p SEARCH_CVES()
